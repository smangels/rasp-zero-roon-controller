---

- name: Network Getting Started First Playbook
  gather_facts: false
  hosts: roon
  tasks:

    - name: Debug - zone name
      debug:
        msg: "{{ zone_name }}"

    - name: Create a group
      group:
        name: "{{ service.group }}"
        state: present

    - name: Ensure service has been stopped
      ignore_errors: yes
      systemd:
        name: "{{ service.name }}.service"
        state: stopped
        enabled: false


    - name: Create a user
      user:
        name: "{{ service.user }}"
        comment: Roon Remote User
        groups: "{{ service.groups }}"

    - name: Remove Installation Folder
      file:
        dest: "{{ installation.folder }}/"
        state: absent

    - name: Git checkout
      git:
        repo: 'https://github.com/smangels/rasp-zero-roon-controller.git'
        dest: "{{ installation.folder }}"
        version: release
        force: true

    - name: Chown Installation Folder
      file:
        dest: "{{ installation.folder }}"
        state: directory
        recurse: true
        owner: "{{ service.user }}"
        group: "{{ service.group }}"
        mode: '770'

    - name: PIP install required packages
      pip:
        name: [ 'roonapi', 'evdev' ]
        state: present

    - name: Copy systemd service file
      copy:
        src: "{{ service.name }}.service"
        dest: "/etc/systemd/system/{{ service.name }}.service"

    - name: Enable and start the service
      systemd:
        name: "{{ service.name }}.service"
        daemon_reload: true
        enabled: true
        state: stopped
